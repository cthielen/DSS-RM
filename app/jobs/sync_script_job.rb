require 'sync'

# Emit a warning in the log if a script takes longer than this (in seconds)
SLOW_SCRIPT_WARNING = 60

# Runs a single sync script for a single user/role job.
# These jobs are generated by the sync subsystem found in lib/sync.rb.
# Do not create these jobs outside lib/sync.rb.
SyncScriptJob = Struct.new(:job_uuid, :sync_script, :sync_json) do
  # def enqueue(job)
  # end

  def perform
    script_start_ts = Time.now

    # Call the script, piping the JSON
    ret = IO.popen(sync_script, 'r+', :err => [:child, :out]) do |pipe|
      pipe.puts sync_json
      pipe.close_write
      pipe.gets(nil)
    end

    script_finish_ts = Time.now

    # e.g. "638aa9a4-4ef9-4a21-b223-28adfba578a1: active_directory.rb:"
    log_tag = "#{job_uuid}: #{sync_script.split(File::SEPARATOR)[-1]}:"

    if script_finish_ts - script_start_ts > SLOW_SCRIPT_WARNING
      Sync.logger.warn "#{log_tag} SLOW SCRIPT (#{script_finish_ts - script_start_ts}s)"
    end

    if $?.exitstatus != 0
      log_txt = "#{log_tag} ERROR (#{script_finish_ts - script_start_ts}s)\n"
      log_txt += "#{log_tag} \t" + ret.gsub("\n", "\n#{log_tag} \t") if ret and ret.length > 0
      Sync.logger.error(log_txt)
      raise log_txt # this will allow our script output to appear in Delayed::Job.last_error
    else
      Sync.logger.info "#{log_tag} SUCCESS (#{script_finish_ts - script_start_ts}s)"
      Sync.logger.info "#{log_tag} \t" + ret.gsub("\n", "\n#{log_tag} \t") if ret and ret.length > 0
    end
  end

  # def before(job)
  # end

  # def after(job)
  # end

  # def success(job)
  # end

  # We don't need to care about error because we throw the error ourselves
  # in 'perform' if the external script fails.
  # def error(job, exception)
  # end

  def failure(job)
    # TODO: Make the failure e-mail delivery address configurable
    AdminMailer.sync_script_failed("dssit-devs-exceptions@ucdavis.edu", job).deliver!
  end

  def reschedule_at(current_time, attempts)
    current_time + 30.seconds + (120.seconds * attempts)
  end

  def max_attempts
    10
  end

  def max_run_time
    28800 # 8 hours (in seconds)
  end
end
